name: Build, Test, and Export

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: NullAndVoid
  DOTNET_VERSION: '8.0.x'
  COVERAGE_THRESHOLD: 70

jobs:
  test:
    name: Build, Test & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Check formatting
        run: dotnet format NullAndVoid.sln --verify-no-changes --exclude NullAndVoid.Tests/

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Run tests with coverage
        run: |
          dotnet test --no-build -c Release \
            --settings coverage.runsettings \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx;LogFileName=test-results.trx"

      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5.2.4
        with:
          reports: 'TestResults/**/coverage.cobertura.xml'
          targetdir: 'CoverageReport'
          reporttypes: 'HtmlInline_AzurePipelines;Cobertura;Badges'

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: CoverageReport

      - name: Check coverage threshold
        run: |
          COVERAGE_FILE=$(find TestResults -name "coverage.cobertura.xml" -type f | head -1)
          if [ -z "$COVERAGE_FILE" ]; then
            echo "No coverage file found - skipping threshold check"
            exit 0
          fi
          COVERAGE=$(grep -oP 'line-rate="\K[^"]+' "$COVERAGE_FILE" | head -1)
          COVERAGE_PCT=$(echo "scale=2; $COVERAGE * 100" | bc)
          echo "Coverage: $COVERAGE_PCT%"
          if (( $(echo "$COVERAGE_PCT < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "::error::Coverage ($COVERAGE_PCT%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
            exit 1
          fi
          echo "Coverage check passed: $COVERAGE_PCT% >= ${{ env.COVERAGE_THRESHOLD }}%"

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: TestResults/*.trx
          reporter: dotnet-trx

  export-windows:
    name: Export Windows
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    container:
      image: barichello/godot-ci:mono-4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable.mono ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable.mono

      - name: Build C#
        run: |
          cd $GITHUB_WORKSPACE
          dotnet restore
          dotnet build --configuration Release

      - name: Windows Build
        run: |
          mkdir -v -p build/windows
          cd $GITHUB_WORKSPACE
          godot --headless --export-release "Windows Desktop" build/windows/$EXPORT_NAME.exe || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows

  export-linux:
    name: Export Linux
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    container:
      image: barichello/godot-ci:mono-4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable.mono ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable.mono

      - name: Build C#
        run: |
          cd $GITHUB_WORKSPACE
          dotnet restore
          dotnet build --configuration Release

      - name: Linux Build
        run: |
          mkdir -v -p build/linux
          cd $GITHUB_WORKSPACE
          godot --headless --export-release "Linux" build/linux/$EXPORT_NAME.x86_64 || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux
